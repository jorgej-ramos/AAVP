---
import Doc from '../layouts/Doc.astro';
import { readFileSync } from 'node:fs';
import { resolve } from 'node:path';
import { createMarkdownProcessor } from '@astrojs/markdown-remark';
import rehypeMermaid from 'rehype-mermaid';

// Tell Shiki to skip mermaid code blocks so rehype-mermaid can process them.
const processor = await createMarkdownProcessor({
  syntaxHighlight: {
    type: 'shiki',
    excludeLangs: ['mermaid'],
  },
  rehypePlugins: [
    [rehypeMermaid, { strategy: 'img-svg', dark: false }],
  ],
});

const mdPath = resolve(process.cwd(), '..', 'SECURITY-ANALYSIS.md');
const rawContent = readFileSync(mdPath, 'utf-8');

// Fix internal links for the website
const content = rawContent
  .replace(
    /\[PROTOCOL\.md\]\(PROTOCOL\.md\)/g,
    '[PROTOCOL.md](/AAVP/protocolo/)'
  )
  .replace(
    /\[README\.md\]\(README\.md\)/g,
    '[README.md](/AAVP/white-paper/)'
  );

const { code: html } = await processor.render(content);
---

<Doc title="Analisis de Seguridad â€” AAVP" currentPage="seguridad">
  <Fragment set:html={html} />
</Doc>
