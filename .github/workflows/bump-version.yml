name: Release

# Trigger: push a semver tag to main.
#   git tag v0.3.0 && git push origin v0.3.0
#
# The workflow extracts the version from the tag name, updates every
# file that carries a version string (VERSION, README.md, PROTOCOL.md,
# CHANGELOG.md), commits the changes if any, and moves the tag so it
# points to the final commit with all headers already updated.
#
# Idempotent: if a previous run already committed the updates but
# failed on the tag step, re-pushing the tag will skip the commit
# and only recreate the tag on HEAD.

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Extract version from tag
        id: tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG"         >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Read current version
        id: current
        run: |
          CURRENT=$(head -1 VERSION | tr -d '[:space:]')
          echo "version=$CURRENT" >> "$GITHUB_OUTPUT"

      - name: Validate version
        env:
          NEW: ${{ steps.tag.outputs.version }}
          OLD: ${{ steps.current.outputs.version }}
        run: |
          # Allow equal (idempotent retry) or greater (normal bump)
          printf '%s\n%s' "$OLD" "$NEW" | sort -V | tail -1 | grep -qx "$NEW" || {
            echo "::error::Tag version ($NEW) is less than current VERSION ($OLD)."
            exit 1
          }
          echo "::notice::Release $OLD -> $NEW"

      - name: Update VERSION file
        run: echo "${{ steps.tag.outputs.version }}" > VERSION

      - name: Update README.md header
        run: |
          sed -i \
            "s/White Paper v[0-9]*\.[0-9]*\.[0-9]*/White Paper v${{ steps.tag.outputs.version }}/" \
            README.md
          sed -i \
            "s/Anonymous Age Verification Protocol · v[0-9]*\.[0-9]*\.[0-9]*/Anonymous Age Verification Protocol · v${{ steps.tag.outputs.version }}/" \
            README.md

      - name: Update PROTOCOL.md header
        run: |
          sed -i \
            "s/v[0-9]*\.[0-9]*\.[0-9]* — Borrador/v${{ steps.tag.outputs.version }} — Borrador/" \
            PROTOCOL.md
          sed -i \
            "s/Especificaci.n T.cnica · v[0-9]*\.[0-9]*\.[0-9]*/Especificación Técnica · v${{ steps.tag.outputs.version }}/" \
            PROTOCOL.md

      - name: Update SECURITY-ANALYSIS.md header
        run: |
          sed -i \
            "s/v[0-9]*\.[0-9]*\.[0-9]* — Documento de trabajo/v${{ steps.tag.outputs.version }} — Documento de trabajo/" \
            SECURITY-ANALYSIS.md
          sed -i \
            "s/Vulnerabilidades · v[0-9]*\.[0-9]*\.[0-9]*/Vulnerabilidades · v${{ steps.tag.outputs.version }}/" \
            SECURITY-ANALYSIS.md

      - name: Stamp CHANGELOG.md
        env:
          NEW_VERSION: ${{ steps.tag.outputs.version }}
          OLD_VERSION: ${{ steps.current.outputs.version }}
        run: |
          TODAY=$(date +%Y-%m-%d)

          # Only stamp if [Unreleased] has not already been replaced for this version
          if ! grep -q "^## \[${NEW_VERSION}\]" CHANGELOG.md; then
            sed -i "s/^## \[Unreleased\]$/## [Unreleased]\n\n## [${NEW_VERSION}] - ${TODAY}/" \
              CHANGELOG.md

            # Update Unreleased comparison link
            sed -i \
              "s|\[Unreleased\]: \(.*\)/compare/v.*\.\.\.HEAD|[Unreleased]: \1/compare/v${NEW_VERSION}...HEAD|" \
              CHANGELOG.md

            # Add new version comparison link if not present
            if ! grep -q "^\[${NEW_VERSION}\]:" CHANGELOG.md; then
              sed -i \
                "/^\[Unreleased\]:.*HEAD$/a [${NEW_VERSION}]: https://github.com/${{ github.repository }}/compare/v${OLD_VERSION}...v${NEW_VERSION}" \
                CHANGELOG.md
            fi
          fi

      - name: Commit if there are changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add VERSION README.md PROTOCOL.md SECURITY-ANALYSIS.md CHANGELOG.md

          if git diff --cached --quiet; then
            echo "No changes to commit (previous run already applied updates)."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "Release v${{ steps.tag.outputs.version }}"
            git push origin main
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Move tag to latest main commit
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          # Check if the tag already points to HEAD (idempotent re-run)
          TAG_COMMIT=$(git rev-parse "${TAG}^{commit}" 2>/dev/null || echo "")
          HEAD_SHA=$(git rev-parse HEAD)

          if [ "$TAG_COMMIT" = "$HEAD_SHA" ]; then
            echo "Tag ${TAG} already points to HEAD (${HEAD_SHA}). Nothing to do."
            exit 0
          fi

          # Delete local tag (from checkout)
          git tag -d "${TAG}" 2>/dev/null || true

          # Delete remote tag
          git push origin ":refs/tags/${TAG}" 2>/dev/null || true

          # Recreate annotated tag on HEAD (which has updated headers)
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"
